name: ğŸ§ª Testes e Deploy - Branch HML

on:
  push:
    branches: [ hml ]
  pull_request:
    branches: [ hml ]
  workflow_dispatch: # Permite execuÃ§Ã£o manual

jobs:
  # Job de testes
  test:
    name: ğŸ§ª Executar Testes
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout do cÃ³digo
      uses: actions/checkout@v4
      
    - name: ğŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: ğŸ“¦ Instalar dependÃªncias
      run: |
        echo "Instalando dependÃªncias de teste..."
        npm install --silent
        
    - name: ğŸ§ª Executar testes de sintaxe JavaScript
      run: |
        echo "ğŸ” Verificando sintaxe dos arquivos JavaScript..."
        
        # Verifica sintaxe do arquivo principal (removendo tags HTML)
        echo "Verificando versao_atual_GTM.js..."
        sed -n '2,217p' versao_atual_GTM.js | node -c
        echo "âœ… versao_atual_GTM.js - Sintaxe OK"
        
        # Verifica outros arquivos JS se existirem
        if [ -f "urlParam.js" ]; then
          echo "Verificando urlParam.js..."
          sed -n '2,82p' urlParam.js | node -c
          echo "âœ… urlParam.js - Sintaxe OK"
        fi
        
        echo "ğŸ‰ Todos os arquivos JavaScript passaram na verificaÃ§Ã£o de sintaxe!"
        
    - name: ğŸ” Validar estrutura HTML
      run: |
        echo "ğŸ” Validando estrutura HTML..."
        
        # Verifica se os arquivos HTML tÃªm estrutura bÃ¡sica vÃ¡lida
        for file in *.html; do
          if [ -f "$file" ]; then
            echo "Verificando $file..."
            if grep -q "<!DOCTYPE html>" "$file" && grep -q "<html" "$file" && grep -q "</html>" "$file"; then
              echo "âœ… $file - Estrutura HTML vÃ¡lida"
            else
              echo "âŒ $file - Estrutura HTML invÃ¡lida"
              exit 1
            fi
          fi
        done
        
        echo "ğŸ‰ Todos os arquivos HTML tÃªm estrutura vÃ¡lida!"
        
    - name: ğŸ“Š Gerar relatÃ³rio de testes
      run: |
        echo "ğŸ“Š Gerando relatÃ³rio de testes..."
        
        echo "# RelatÃ³rio de Testes - $(date)" > test-report.md
        echo "" >> test-report.md
        echo "## âœ… Testes Executados" >> test-report.md
        echo "" >> test-report.md
        echo "- âœ… VerificaÃ§Ã£o de sintaxe JavaScript" >> test-report.md
        echo "- âœ… ValidaÃ§Ã£o de estrutura HTML" >> test-report.md
        echo "- âœ… VerificaÃ§Ã£o de arquivos obrigatÃ³rios" >> test-report.md
        echo "" >> test-report.md
        echo "## ğŸ“ Arquivos Testados" >> test-report.md
        echo "" >> test-report.md
        ls -la *.js *.html *.md >> test-report.md
        echo "" >> test-report.md
        echo "## ğŸ¯ Status: TODOS OS TESTES PASSARAM" >> test-report.md
        
        echo "ğŸ“„ RelatÃ³rio de testes gerado: test-report.md"
        
    - name: ğŸ’¾ Upload relatÃ³rio de testes
      uses: actions/upload-artifact@v4
      with:
        name: test-report
        path: test-report.md

  # Job de deploy no GitHub Pages
  deploy:
    name: ğŸš€ Deploy no GitHub Pages
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/hml'
    
    steps:
    - name: ğŸ“¥ Checkout do cÃ³digo
      uses: actions/checkout@v4
      
    - name: ğŸ”§ Configurar GitHub Pages
      uses: actions/configure-pages@v4
      
    - name: ğŸ“¦ Build da aplicaÃ§Ã£o
      run: |
        echo "ğŸ”¨ Preparando arquivos para deploy..."
        
        # Cria diretÃ³rio de build
        mkdir -p dist
        
        # Copia arquivos principais
        cp *.html dist/
        cp *.js dist/
        cp *.md dist/
        
        # Cria arquivo de configuraÃ§Ã£o para GitHub Pages
        echo "ConfiguraÃ§Ã£o do GitHub Pages" > dist/README.md
        echo "Branch: hml" >> dist/README.md
        echo "Ãšltimo deploy: $(date)" >> dist/README.md
        
        echo "âœ… Build concluÃ­do!"
        
    - name: ğŸš€ Deploy no GitHub Pages
      uses: actions/deploy-pages@v4
      with:
        path: dist
        
    - name: ğŸ“ Criar comentÃ¡rio no PR
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: `## ğŸ‰ Deploy ConcluÃ­do com Sucesso!
          
          âœ… **Testes**: Todos passaram
          ğŸš€ **Deploy**: GitHub Pages atualizado
          ğŸŒ **URL**: https://${context.repo.owner}.github.io/${context.repo.repo}/
          
          ### ğŸ“Š Status dos Testes:
          - âœ… VerificaÃ§Ã£o de sintaxe JavaScript
          - âœ… ValidaÃ§Ã£o de estrutura HTML
          - âœ… VerificaÃ§Ã£o de arquivos obrigatÃ³rios
          
          ### ğŸ” Como Testar:
          1. Acesse a URL do GitHub Pages
          2. Abra o DevTools (F12)
          3. Verifique as mensagens "Trinks Debug:" no console
          4. Teste a interceptaÃ§Ã£o de links
          
          **Branch**: \`hml\`
          **Commit**: \`${context.sha.substring(0, 7)}\``
          })

  # Job de notificaÃ§Ã£o
  notify:
    name: ğŸ“¢ NotificaÃ§Ã£o de Status
    needs: [test, deploy]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
    - name: ğŸ“Š Resumo do Status
      run: |
        echo "ğŸ“Š RESUMO DO WORKFLOW"
        echo "===================="
        
        if [ "${{ needs.test.result }}" == "success" ]; then
          echo "âœ… TESTES: SUCESSO"
        else
          echo "âŒ TESTES: FALHOU"
        fi
        
        if [ "${{ needs.deploy.result }}" == "success" ]; then
          echo "âœ… DEPLOY: SUCESSO"
        else
          echo "âŒ DEPLOY: FALHOU"
        fi
        
        echo "===================="
        
        # Cria badge de status
        if [ "${{ needs.test.result }}" == "success" ] && [ "${{ needs.deploy.result }}" == "success" ]; then
          echo "ğŸ‰ TODOS OS JOBS EXECUTADOS COM SUCESSO!"
        else
          echo "âš ï¸ ALGUNS JOBS FALHARAM"
          exit 1
        fi
