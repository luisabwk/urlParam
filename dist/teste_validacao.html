<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Teste de Valida√ß√£o - Corre√ß√µes Implementadas</title>
  
  <!-- Script principal do GTM -->
  <script src="versao_atual_GTM.js"></script>
  
  <!-- Script de fallback caso o principal n√£o carregue -->
  <script>
    // Aguarda o carregamento da p√°gina
    document.addEventListener('DOMContentLoaded', function() {
      // Verifica se as fun√ß√µes foram carregadas
      setTimeout(function() {
        if (typeof window.initCookies === 'undefined') {
          console.log('Trinks Debug: Script principal n√£o carregou, carregando fallback...');
          
          // Carrega o script novamente
          var script = document.createElement('script');
          script.src = 'versao_atual_GTM.js?v=' + Date.now();
          script.onload = function() {
            console.log('Trinks Debug: Script principal carregado via fallback');
          };
          script.onerror = function() {
            console.log('Trinks Debug: Erro ao carregar script principal');
          };
          document.head.appendChild(script);
        }
      }, 1000);
    });
  </script>
  
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    .container { max-width: 800px; margin: 0 auto; }
    .section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
    .success { background-color: #d4edda; border-color: #c3e6cb; }
    .warning { background-color: #fff3cd; border-color: #ffeaa7; }
    .info { background-color: #d1ecf1; border-color: #bee5eb; }
    .code { background: #f8f9fa; padding: 10px; border-radius: 3px; font-family: monospace; }
    button { padding: 10px 20px; margin: 5px; background: #007bff; color: white; border: none; border-radius: 3px; cursor: pointer; }
    button:hover { background: #0056b3; }
    .log { background: #000; color: #0f0; padding: 10px; border-radius: 3px; font-family: monospace; max-height: 300px; overflow-y: auto; }
  </style>
</head>
<body>
  <div class="container">
    <h1>üß™ Teste de Valida√ß√£o - Corre√ß√µes Implementadas</h1>
    
    <div class="section warning">
      <h3>‚ö†Ô∏è COMO USAR - LEIA PRIMEIRO!</h3>
      <ol>
        <li><strong>Abra o DevTools (F12)</strong> e v√° para a aba Console</li>
        <li><strong>Aguarde alguns segundos</strong> para o script carregar</li>
        <li><strong>Clique nos bot√µes de teste</strong> acima</li>
        <li><strong>Verifique se as mensagens "Trinks Debug:"</strong> aparecem no console</li>
        <li><strong>Monitore os logs</strong> na se√ß√£o abaixo</li>
      </ol>
    </div>

    <div class="section success">
      <h3>‚úÖ RESULTADO ESPERADO - O QUE DEVE ACONTECER</h3>
      <p>Ap√≥s executar os testes, voc√™ deve ver:</p>
      <ul>
        <li><strong>‚úÖ Script carregado</strong> - Mensagens "Trinks Debug:" no console</li>
        <li><strong>‚úÖ Cookies sendo criados</strong> corretamente</li>
        <li><strong>‚úÖ Eventos sendo enviados</strong> para o dataLayer</li>
        <li><strong>‚úÖ URLs sendo constru√≠das</strong> com par√¢metros</li>
        <li><strong>‚úÖ Campo "URL Gerada"</strong> sendo preenchido</li>
        <li><strong>‚úÖ Logs detalhados</strong> em cada etapa</li>
      </ul>
    </div>

    <div class="section info">
      <h3>üìã Objetivo do Teste</h3>
      <p>Este arquivo testa se as corre√ß√µes implementadas no <code>versao_atual_GTM.js</code> est√£o funcionando corretamente.</p>
    </div>

    <div class="section">
      <h3>üîß Funcionalidades Testadas</h3>
      <ul>
        <li>‚úÖ Captura de cookies sem dupla codifica√ß√£o</li>
        <li>‚úÖ Envio de eventos para GTM via dataLayer</li>
        <li>‚úÖ Constru√ß√£o de URL com par√¢metros</li>
        <li>‚úÖ Logs de debug em cada etapa</li>
        <li>‚úÖ Intercepta√ß√£o de links</li>
      </ul>
    </div>

    <div class="section">
      <h3>üß™ Testes Dispon√≠veis</h3>
      <button onclick="testarCookies()">Testar Captura de Cookies</button>
      <button onclick="testarDataLayer()">Testar Envio para GTM</button>
      <button onclick="testarURLBuilder()">Testar Construtor de URL</button>
      <button onclick="testarInterceptacao()">Testar Intercepta√ß√£o</button>
      <button onclick="limparLogs()">Limpar Logs</button>
    </div>

    <div class="section">
      <h3>üìä Status dos Cookies</h3>
      <div id="cookieStatus"></div>
    </div>

    <div class="section">
      <h3>üîó URL Gerada</h3>
      <div id="urlGerada" class="code"></div>
    </div>

    <div class="section">
      <h3>üìù Logs de Debug</h3>
      <div id="logs" class="log"></div>
    </div>


  </div>

  <script>
    // Fun√ß√£o para adicionar logs
    function adicionarLog(mensagem, tipo = 'info') {
      const logsDiv = document.getElementById('logs');
      const timestamp = new Date().toLocaleTimeString();
      const logEntry = document.createElement('div');
      logEntry.innerHTML = `[${timestamp}] ${mensagem}`;
      logsDiv.appendChild(logEntry);
      logsDiv.scrollTop = logsDiv.scrollHeight;
    }

    // Fun√ß√£o para limpar logs
    function limparLogs() {
      document.getElementById('logs').innerHTML = '';
      adicionarLog('Logs limpos');
    }

    // Fun√ß√£o para testar captura de cookies
    function testarCookies() {
      adicionarLog('üß™ Testando captura de cookies...');
      
      // Simula a fun√ß√£o initCookies
      if (typeof window.initCookies === 'function') {
        window.initCookies();
        adicionarLog('‚úÖ Fun√ß√£o initCookies executada');
      } else {
        adicionarLog('‚ùå Fun√ß√£o initCookies n√£o encontrada');
      }
      
      atualizarStatusCookies();
    }

    // Fun√ß√£o para testar dataLayer
    function testarDataLayer() {
      adicionarLog('üß™ Testando envio para dataLayer...');
      
      if (typeof window.captureFirstClick === 'function') {
        window.captureFirstClick();
        adicionarLog('‚úÖ Fun√ß√£o captureFirstClick executada');
        
        // Verifica se o evento foi enviado
        if (window.dataLayer && window.dataLayer.length > 0) {
          const ultimoEvento = window.dataLayer[window.dataLayer.length - 1];
          adicionarLog(`‚úÖ Evento enviado para dataLayer: ${ultimoEvento.event}`);
        } else {
          adicionarLog('‚ùå Nenhum evento encontrado no dataLayer');
        }
      } else {
        adicionarLog('‚ùå Fun√ß√£o captureFirstClick n√£o encontrada');
      }
    }

    // Fun√ß√£o para testar construtor de URL
    function testarURLBuilder() {
      adicionarLog('üß™ Testando construtor de URL...');
      
      if (typeof window.urlBuilder === 'function') {
        const url = window.urlBuilder();
        document.getElementById('urlGerada').textContent = url;
        adicionarLog(`‚úÖ URL gerada: ${url}`);
      } else {
        adicionarLog('‚ùå Fun√ß√£o urlBuilder n√£o encontrada');
      }
    }

    // Fun√ß√£o para testar intercepta√ß√£o
    function testarInterceptacao() {
      adicionarLog('üß™ Testando intercepta√ß√£o...');
      
      if (typeof window.interceptAndRedirect === 'function') {
        adicionarLog('‚ö†Ô∏è Executando interceptAndRedirect (pode redirecionar)...');
        // Comentado para evitar redirecionamento durante teste
        // window.interceptAndRedirect();
        adicionarLog('‚úÖ Fun√ß√£o interceptAndRedirect dispon√≠vel');
      } else {
        adicionarLog('‚ùå Fun√ß√£o interceptAndRedirect n√£o encontrada');
      }
    }

    // Fun√ß√£o para atualizar status dos cookies
    function atualizarStatusCookies() {
      const cookies = ['referrer', 'landingUrl', 'device', 'firstLandingUrl', 'firstLandingUrlDateTime', 'firstClickUrl', 'firstClickUrlDateTime'];
      const statusDiv = document.getElementById('cookieStatus');
      
      let html = '<table style="width:100%; border-collapse: collapse;">';
      html += '<tr><th>Cookie</th><th>Valor</th><th>Status</th></tr>';
      
      cookies.forEach(cookie => {
        const valor = getCookie(cookie);
        const status = valor ? '‚úÖ Definido' : '‚ùå N√£o definido';
        const valorExibido = valor ? (valor.length > 50 ? valor.substring(0, 50) + '...' : valor) : 'N/A';
        
        html += `<tr style="border-bottom: 1px solid #ddd;">`;
        html += `<td style="padding: 5px;"><strong>${cookie}</strong></td>`;
        html += `<td style="padding: 5px; font-family: monospace;">${valorExibido}</td>`;
        html += `<td style="padding: 5px;">${status}</td>`;
        html += `</tr>`;
      });
      
      html += '</table>';
      statusDiv.innerHTML = html;
    }

    // Fun√ß√£o para obter cookie (simulada)
    function getCookie(name) {
      const cookies = document.cookie.split(';');
      for (let c of cookies) {
        c = c.trim();
        if (c.indexOf(name + '=') === 0) {
          return c.substring(name.length + 1);
        }
      }
      return null;
    }

    // Inicializa√ß√£o
    document.addEventListener('DOMContentLoaded', function() {
      adicionarLog('üöÄ P√°gina carregada, iniciando testes...');
      atualizarStatusCookies();
      
      // Verifica se o script principal est√° carregado
      setTimeout(() => {
        if (typeof window.interceptAndRedirect === 'function') {
          adicionarLog('‚úÖ Script principal carregado com sucesso');
        } else {
          adicionarLog('‚ùå Script principal n√£o encontrado');
        }
      }, 1000);
    });

    // Intercepta logs do console
    const originalLog = console.log;
    console.log = function(...args) {
      originalLog.apply(console, args);
      
      // Filtra apenas logs do Trinks
      const mensagem = args.join(' ');
      if (mensagem.includes('Trinks Debug:')) {
        adicionarLog(`üîç ${mensagem}`);
      }
    };
  </script>
</body>
</html>
